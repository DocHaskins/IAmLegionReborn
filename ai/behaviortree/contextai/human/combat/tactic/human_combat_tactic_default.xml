<?xml version="1.0"?>
<BehaviorTree xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../../../MetaData/schema_ai.xsd" m_ContextType="ai">
    <Sequence>
        <!-- defaults -->
        <Opr_SetBBValue_bool m_Key="#attack_token_release_on_damage" m_Value="false"/>
        <!-- tactics -->
        <Selector>
            <!-- rush -->
            <Optional m_Enabled="$enable_tactic_rush">
                <Sequence>
                    <Selector>
                        <Optional m_Enabled="$tactic_rush_target_escaping">
                            <Selector>
                                <Sequence>
                                    <Opr_GetDistanceTraveledByTarget m_Time="3.0" m_Distance="#distance_traveled"/>
                                    <Selector>
                                        <Cnd_IsCombatTargetInRadius m_Radius="15.0" m_Invert="true"/>
                                        <Cnd_IsBBValueGreater_float m_Key="#distance_traveled" m_Value="15.0"/>
                                    </Selector>
                                    <Opr_GetCurrentTime m_TimePoint="#target_escape_time"/>
                                </Sequence>
                                <Sequence>
                                    <Cnd_HasBBValue m_Key="#target_escape_time"/>
                                    <Cnd_HasTimePassed m_TimePoint="#target_escape_time" m_TimeDelta="2" m_Invert="true"/>
                                </Sequence>
                            </Selector>
                        </Optional>
                        <Cnd_HasTargetLowHealth m_Target="#target" m_MaxHealthLevel="$tactic_rush_target_max_health_level"/>
                    </Selector>
                    <Opr_SetBBValue_string m_Key="#tactic" m_Value="rush"/>
                    <Opr_GetCurrentTime m_TimePoint="#attack_cooldown"/>
                    <Opr_SetBBValue_float m_Key="#attack_quick_min_delay" m_Value="0"/>
                    <Opr_SetBBValue_bool m_Key="#attack_token_release_on_damage" m_Value="true"/>
                    <Opr_SetBBValue_string m_Key="#morale_state" m_Value="aggressive"/>
                </Sequence>
            </Optional>
            <!-- stay back -->
            <Optional m_Enabled="$enable_tactic_stay_back">
                <Sequence>
                    <Selector>
                        <Sequence>
                            <Cnd_IsCombatTargetInRadius m_Radius="$enable_tactic_stay_back_calm_min_range" m_Invert="true"/>
                            <Opr_GetCurrentTime m_TimePoint="#stay_back_cooldown"/>
                        </Sequence>
                        <Selector>
                            <Cnd_IsCombatTargetInRadius m_Radius="$enable_tactic_stay_back_aggression_max_range" m_Invert="true"/>
                            <Opr_GetModifiedTime m_TimePoint="#stay_back_cooldown" m_TimeDelta="$enable_tactic_stay_back_aggression_time"/>
                        </Selector>
                    </Selector>
                    <Selector>
                        <Cnd_HasBBValue m_Key="#stay_back_cooldown" m_Invert="true"/>
                        <Cnd_HasTimePassed m_TimePoint="#stay_back_cooldown"/>
                    </Selector>
                    <Cnd_AreCombatSlotsOccupiedByOthers m_Name="melee" m_MinNumOfOccupiedSlots="5"/>
                    <Opr_SetBBValue_string m_Key="#tactic" m_Value="stay_back"/>
                    <Opr_SetBBValue_string m_Key="#morale_state" m_Value="cautious"/>
                </Sequence>
            </Optional>
            <!-- aggressive -->
            <Sequence>
                <Selector>
                    <Sequence>
                        <Selector>
                            <Cnd_IsCombatTargetInRadius m_Radius="4"/>
                            <Cnd_IsOtherGroupMemberCloseToPosition m_Position="#target_pos" m_MaxDistance="4"/>
                        </Selector>
                        <Cnd_IsTargetAttacking m_Target="#target"/>
                        <!-- set aggresion time -->
                        <Opr_GetModifiedTime m_TimePoint="#aggressive_time" m_TimeDelta="2"/>
                    </Sequence>
                    <Sequence>
                        <Cnd_HasBBValue m_Key="#aggressive_time"/>
                        <Cnd_HasTimePassed m_TimePoint="#aggressive_time" m_Invert="true"/>
                    </Sequence>
                </Selector>
                <Opr_SetBBValue_string m_Key="#tactic" m_Value="aggressive"/>
                <Opr_SetBBValue_float m_Key="#attack_quick_min_delay" m_Value="$attack_quick_min_delay"/>
                <Opr_SetBBValue_string m_Key="#morale_state" m_Value="aggressive"/>
            </Sequence>
            <!-- cautious -->
            <Optional m_Enabled="$enable_tactic_cautious">
                <Sequence>
                    <Cnd_HasActiveWeapon m_WeaponType="TwoHandedMelee" m_Invert="true"/>
                    <Selector>
                        <!-- #TODO combat prototype - cautious tactics as default -->
                        <Act_Status m_StatusRequired="SUCCESS"/>
                        <Cnd_HasGroupMemberDiedRecently m_TimeWindow="5"/>
                        <Optional m_Enabled="$enable_tactic_cautious_at_start">
                            <Cnd_IsGroupDamaged m_Invert="true"/>
                        </Optional>
                        <Sequence>
                            <Cnd_IsCombatTargetInRadius m_Radius="4"/>
                            <Cnd_IsOtherGroupMemberCloseToPosition m_Position="#target_pos" m_MaxDistance="4"/>
                        </Sequence>
                    </Selector>
                    <Opr_SetBBValue_string m_Key="#tactic" m_Value="cautious"/>
                    <Opr_SetBBValue_string m_Key="#morale_state" m_Value="cautious"/>
                </Sequence>
            </Optional>
            <!-- default -->
            <Sequence>
                <Opr_SetBBValue_string m_Key="#tactic" m_Value="default"/>
                <Opr_SetBBValue_float m_Key="#attack_quick_min_delay" m_Value="$attack_quick_min_delay"/>
                <Opr_SetBBValue_string m_Key="#morale_state" m_Value="aggressive"/>
            </Sequence>
        </Selector>
    </Sequence>
</BehaviorTree>
